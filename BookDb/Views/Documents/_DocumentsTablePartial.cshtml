@using BookDb.Models
@model BookDb.Views.Documents.IndexModel

@foreach (var item in Model.Documents)
{
    <tr data-document-id="@item.Id" class="document-card">
        <td><strong>@item.Title</strong></td>
        <td><span class="badge bg-info">@item.Category</span></td>
        <td>@item.Author</td>
        <td>@Model.GetFormattedDate(item.CreatedAt)</td>
        <td>
            <!-- View button - available for everyone -->
            <a asp-action="ViewDocument" asp-route-id="@(item.Id)"
               class="btn btn-sm btn-success">
                <i class="bi bi-eye"></i> Xem
            </a>

            @* Permission logic:
 - When viewing all documents (OnlyMine == false): only Admin sees Edit/Delete for each document.
 - When viewing only the user's documents (OnlyMine == true): Admin and the owner see Edit/Delete.
 *@
@if (User?.Identity?.IsAuthenticated == true)
{
    var userId = User.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value;
    var isOwner = !string.IsNullOrEmpty(userId) && !string.IsNullOrEmpty(item.OwnerId) && string.Equals(item.OwnerId, userId, StringComparison.OrdinalIgnoreCase);
    var isAdmin = User.IsInRole(Roles.Admin);

    var canManage = false;

    if (!Model.OnlyMine)
    {
        // Viewing all documents: only Admin may manage
        if (isAdmin)
        {
            canManage = true;
        }
    }
    else
    {
        // Viewing only the user's documents: Admin or the owner may manage
        if (isAdmin || isOwner)
        {
            canManage = true;
        }
    }

    if (canManage)
    {
        <a asp-action="Edit" asp-route-id="@(item.Id)" class="btn btn-sm btn-warning ms-1">
            <i class="bi bi-pencil"></i> Sửa
        </a>

        <form method="post" asp-action="Delete" asp-route-id="@(item.Id)" class="d-inline-block ms-1">
            @Html.AntiForgeryToken()
            <!-- Visible submit button used for non-JS fallback; JS will intercept to perform AJAX -->
            <button type="submit" class="btn btn-sm btn-danger delete-btn" data-id="@(item.Id)" data-title="@(item.Title)">
                <i class="bi bi-trash"></i> Xóa
            </button>
        </form>
    }
}
        </td>
    </tr>
}

@if (!Model.HasDocuments())
{
    <tr>
        <td colspan="5" class="text-center text-muted py-4">
            <i class="bi bi-inbox" style="font-size:32px;"></i>
            <p class="mt-2">Không có tài liệu nào</p>
        </td>
    </tr>
}