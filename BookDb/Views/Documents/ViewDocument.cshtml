@model BookDb.Views.Documents.ViewDocumentModel

@{
    ViewData["Title"] = Model.Title;
}

<style>
    #addBookmarkBtn, #deleteBookmarkBtn {
        transition: all 0.3s ease;
        min-width: 150px;
    }

        #addBookmarkBtn:disabled, #deleteBookmarkBtn:disabled {
            cursor: not-allowed;
        }

    .bookmark-success {
        animation: bookmarkPulse 0.5s ease-out;
    }

    @@keyframes bookmarkPulse {
        0%, 100%

    {
        transform: scale(1);
    }

    50% {
        transform: scale(1.05);
    }

    }

    .bookmark-actions {
        display: inline-flex;
        gap: 10px;
        align-items: center;
    }

    .bookmark-info {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        padding: 8px 15px;
        background: #fff3cd;
        border-radius: 6px;
        border: 1px solid #ffc107;
    }
</style>

<h2>@Model.GetDocumentTitle()</h2>
<p>
    <b>T√°c gi·∫£:</b> @Model.GetDocumentAuthor() <br />
    <b>Lƒ©nh v·ª±c:</b> @Model.GetDocumentCategory() <br />
    <b>Ng√†y t·∫°o:</b> @Model.GetFormattedDate() <br />
    <b>M√¥ t·∫£:</b> @Model.GetDocumentDescription()
</p>

<!-- N√∫t chuy·ªÉn ƒë·ªïi gi·ªØa b·∫£n g·ªëc v√† b·∫£n ph√¢n trang -->
<div class="mb-3 d-flex align-items-center">
    @if (Model.IsPagedMode())
    {
        <a asp-action="ViewDocument" asp-route-id="@Model.GetDocumentId()" asp-route-mode="original" class="btn btn-info">
            Xem b·∫£n g·ªëc
        </a>
    }
    else
    {
        <a asp-action="ViewDocument" asp-route-id="@Model.GetDocumentId()" asp-route-mode="paged" class="btn btn-info">
            Xem b·∫£n ph√¢n trang
        </a>
    }

    @* Page controls placed next to the mode switch *@
    @if (Model.IsPagedMode() && Model.HasPages() && Model.TotalPages > 0)
    {
        <div class="ms-3">
            <div class="btn-group" role="group" aria-label="Trang">
                @if (Model.HasPreviousPage())
                {
                    <a asp-action="ViewDocument" asp-route-id="@Model.GetDocumentId()" asp-route-mode="paged" asp-route-page="@Model.GetPreviousPageNumber()" class="btn btn-secondary">‚Üê</a>
                }

                <a class="btn btn-light disabled">@Model.GetPageInfo()</a>

                @if (Model.HasNextPage())
                {
                    <a asp-action="ViewDocument" asp-route-id="@Model.GetDocumentId()" asp-route-mode="paged" asp-route-page="@Model.GetNextPageNumber()" class="btn btn-secondary">‚Üí</a>
                    <a asp-action="ViewDocument" asp-route-id="@Model.GetDocumentId()" asp-route-mode="paged" asp-route-page="@Model.TotalPages" class="btn btn-secondary">Trang cu·ªëi ¬ª</a>
                }
            </div>
        </div>
    }
</div>

<!-- Hi·ªÉn th·ªã PDF v√† HTML (Excel) -->
@if (Model.IsPagedMode())
{
    if (Model.HasPages())
    {
        var currentPageDoc = Model.GetCurrentPageDocument();

        if (currentPageDoc != null)
        {
            var iframeSrc = Url.Content(Model.GetIFrameSource());

            // If the generated page is HTML (from Excel), show it directly. Otherwise (PDF) show inside an iframe as well.
            if (Model.IsHtmlContent())
            {
                <iframe id="docFrame" src="@iframeSrc" width="80%" height="1000px" style="border:1px solid #ccc"></iframe>
            }
            else
            {
                <iframe id="docFrame" src="@iframeSrc" width="60%" height="1200px" style="border:1px solid #ccc"></iframe>
            }

            <!-- Hi·ªÉn th·ªã th√¥ng tin trang hi·ªán t·∫°i / t·ªïng trang -->
            @if (Model.TotalPages > 0)
            {
                <div class="mt-2">@Model.GetPageInfo()</div>
            }

            <!-- Bookmark Actions -->
            <div class="bookmark-actions mt-3">
                @if (Model.CurrentPageHasBookmark())
                {
                    var bookmark = currentPageDoc.Bookmark;
                    <div class="bookmark-info">
                        <span>üîñ <strong>ƒê√£ c√≥ Bookmark:</strong> @(bookmark?.Title ?? "Kh√¥ng c√≥ ti√™u ƒë·ªÅ")</span>
                    </div>

                    <form id="deleteBookmarkForm" asp-controller="Bookmarks" asp-action="Delete" asp-route-id="@bookmark?.Id" method="post" style="display:inline">
                        @Html.AntiForgeryToken()
                        <button type="submit" class="btn btn-danger" id="deleteBookmarkBtn">
                            <span class="spinner-border spinner-border-sm d-none" id="deleteBookmarkSpinner"></span>
                            <i class="bi bi-trash"></i> X√≥a Bookmark
                        </button>
                    </form>
                }
                else
                {
                    <form id="bookmarkForm" asp-controller="Bookmarks" asp-action="Create" method="post" style="display:inline">
                        @Html.AntiForgeryToken()
                        <input type="hidden" name="documentPageId" value="@currentPageDoc.Id" />
                        <button type="submit" class="btn btn-primary" id="addBookmarkBtn">
                            <span class="spinner-border spinner-border-sm d-none" id="bookmarkSpinner"></span>
                            <i class="bi bi-bookmark-plus"></i> Th√™m Bookmark
                        </button>
                    </form>
                }
            </div>
        }
        else
        {
            <p class="text-danger">Trang kh√¥ng t·ªìn t·∫°i.</p>
        }
    }
    else
    {
        <p class="text-danger">T√†i li·ªáu ch∆∞a ƒë∆∞·ª£c ph√¢n trang.</p>
    }
}
else
{
    if (Model.HasFile())
    {
        <iframe id="docFrame" src="@Url.Content(Model.GetFilePath())" width="60%" height="1200px" style="border:1px solid #ccc"></iframe>
    }
    else
    {
        <p class="text-danger">Kh√¥ng t√¨m th·∫•y file g·ªëc.</p>
    }
}

<script src="/lib/microsoft/signalr/dist/browser/signalr.js"></script>
<script src="/js/document-notify.js"></script>
<script>
    (function () {
        var docId = @Model.GetDocumentId();
        var currentPageId = @Model.GetCurrentPageId();
        var currentPageNumber = @Model.Page;
        var mode = '@Model.Mode';

        function onPageChanged(payload, action) {
            try {
                console.log('Page change detected:', action, payload);

                if (action === 'updated') {
                    // If the changed page is the same as currently displayed, reload the iframe
                    if (payload && payload.PageId && payload.PageId === currentPageId) {
                        var frame = document.getElementById('docFrame');
                        if (frame) {
                            // Add timestamp to force reload
                            var src = frame.src.split('?')[0];
                            frame.src = src + '?t=' + new Date().getTime();
                            console.info('Page updated externally, reloaded iframe.');
                        }
                    } else if (payload && payload.PageNumber && payload.PageNumber === currentPageNumber) {
                        // Reload the entire page to reflect changes
                        setTimeout(function() {
                            location.reload();
                        }, 1000);
                    }
                } else if (action === 'added') {
                    // A new page was added, optionally reload to show updated page count
                    console.info('New page added to document');
                    // Could show a notification to refresh
                    if (confirm('C√≥ trang m·ªõi ƒë∆∞·ª£c th√™m v√†o. T·∫£i l·∫°i trang ƒë·ªÉ xem?')) {
                        location.reload();
                    }
                } else if (action === 'deleted') {
                    // A page was deleted
                    if (payload && payload.PageId && payload.PageId === currentPageId) {
                        // Current page was deleted, redirect to first page or document list
                        alert('Trang hi·ªán t·∫°i ƒë√£ b·ªã x√≥a. Chuy·ªÉn v·ªÅ trang ƒë·∫ßu.');
                        window.location.href = '/documents/view/@Model.GetDocumentId()?mode=paged&page=1';
                    } else if (payload && payload.PageNumber && payload.PageNumber === currentPageNumber) {
                        setTimeout(function() {
                            location.reload();
                        }, 1000);
                    }
                }
            } catch (e) {
                console.error('Error handling page change:', e);
            }
        }

        // Start SignalR notification system
        startDocumentNotify(docId, onPageChanged);

        // Leave group when navigating away
        window.addEventListener('beforeunload', function () {
            stopDocumentNotify(docId);
        });
    })();
</script>

<script>
    // Handle bookmark form submission with AJAX
    $(document).ready(function() {
        // Add bookmark
        $('#bookmarkForm').on('submit', function(e) {
            e.preventDefault();

            const form = $(this);
            const submitBtn = $('#addBookmarkBtn');
            const spinner = $('#bookmarkSpinner');

            // Disable button and show spinner
            submitBtn.prop('disabled', true);
            spinner.removeClass('d-none');

            $.ajax({
                url: form.attr('action'),
                type: 'POST',
                data: form.serialize(),
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                },
                success: function(response) {
                    if (response.success) {
                        // Show success notification
                        window.NotificationHub.showLocal('‚úÖ ' + response.message, 'success');

                        // Reload page to show delete button
                        setTimeout(function() {
                            location.reload();
                        }, 1000);
                    } else {
                        handleBookmarkError(response.message);
                        submitBtn.prop('disabled', false);
                        spinner.addClass('d-none');
                    }
                },
                error: function(xhr) {
                    let errorMessage = 'C√≥ l·ªói x·∫£y ra khi l∆∞u bookmark';
                    if (xhr.responseJSON && xhr.responseJSON.message) {
                        errorMessage = xhr.responseJSON.message;
                    }
                    handleBookmarkError(errorMessage);
                    submitBtn.prop('disabled', false);
                    spinner.addClass('d-none');
                }
            });
        });

        // Delete bookmark
        $('#deleteBookmarkForm').on('submit', function(e) {
            e.preventDefault();

            if (!confirm('B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a bookmark n√†y?')) {
                return;
            }

            const form = $(this);
            const submitBtn = $('#deleteBookmarkBtn');
            const spinner = $('#deleteBookmarkSpinner');

            // Disable button and show spinner
            submitBtn.prop('disabled', true);
            spinner.removeClass('d-none');

            $.ajax({
                url: form.attr('action'),
                type: 'POST',
                data: form.serialize(),
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                },
                success: function(response) {
                    if (response.success) {
                        // Show success notification
                        window.NotificationHub.showLocal('‚úÖ ƒê√£ x√≥a bookmark th√†nh c√¥ng', 'success');

                        // Reload page to show add button
                        setTimeout(function() {
                            location.reload();
                        }, 1000);
                    } else {
                        window.NotificationHub.showLocal('‚ùå ' + (response.message || 'Kh√¥ng th·ªÉ x√≥a bookmark'), 'error');
                        submitBtn.prop('disabled', false);
                        spinner.addClass('d-none');
                    }
                },
                error: function(xhr) {
                    let errorMessage = 'C√≥ l·ªói x·∫£y ra khi x√≥a bookmark';
                    if (xhr.status === 404) {
                        errorMessage = 'Kh√¥ng t√¨m th·∫•y bookmark';
                    } else if (xhr.responseJSON && xhr.responseJSON.message) {
                        errorMessage = xhr.responseJSON.message;
                    }
                    window.NotificationHub.showLocal('‚ùå ' + errorMessage, 'error');
                    submitBtn.prop('disabled', false);
                    spinner.addClass('d-none');
                }
            });
        });

        function handleBookmarkError(message) {
            if (message && (message.includes('t·ªìn t·∫°i') || message.includes('ƒë√£ c√≥'))) {
                window.NotificationHub.showLocal('‚ö†Ô∏è ' + message, 'warning');
            } else {
                window.NotificationHub.showLocal('‚ùå ' + message, 'error');
            }
        }

        // Show TempData messages if exists
        @if (TempData["SuccessMessage"] != null)
        {
                <text>
                window.NotificationHub.showLocal('‚úÖ @TempData["SuccessMessage"]', 'success');
                </text>
        }

        @if (TempData["ErrorMessage"] != null)
        {
                <text>
                window.NotificationHub.showLocal('‚ùå @TempData["ErrorMessage"]', 'error');
                </text>
        }
    });
</script>

<p class="mt-3">
    <a asp-action="Index" class="btn btn-secondary">‚Üê Quay l·∫°i danh s√°ch</a>
</p>